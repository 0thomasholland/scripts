#!/bin/sh
# Script to open Jesus College meal menus
# THOMAS HOLLAND

LUNCH="python3 -m webbrowser 'https://apps.jesus.cam.ac.uk/foodmenuview/digiboard.php?event_id=1'"
DINNER="python3 -m webbrowser 'https://apps.jesus.cam.ac.uk/foodmenuview/digiboard.php?event_id=2'"
FORMAL_BASE="https://apps.jesus.cam.ac.uk/foodmenuview/digiboard.php?event_id=5"

if [ "$1" = "l" ]; then
    eval $LUNCH
elif [ "$1" = "d" ]; then
    eval $DINNER
elif [ "$1" = "f" ]; then
    if [ -z "$2" ]; then
        # No date provided, just open the base formal link
        eval "python3 -m webbrowser '${FORMAL_BASE}'"
    else
        YEAR=$(date +%Y)
        MONTH=$(date +%m)
	CURRENT_DAY=$(date +%d)
        
	if [ ${#2} -eq 2 ]; then
            # If day is past current day, increment month
            if [ "$2" -lt "$CURRENT_DAY" ]; then
                # If current month is December, increment year and set month to January
                if [ "$MONTH" -eq 12 ]; then
                    YEAR=$((YEAR + 1))
                    MONTH="01"
                else
                    # Increment month and ensure it's padded with zero if needed
                    MONTH=$((MONTH + 1))
                    MONTH=$(printf "%02d" $MONTH)
                fi
            fi
            DATE="${YEAR}-${MONTH}-$2"        
	elif [ ${#2} -eq 5 ]; then
            # If 5 chars (MM-DD), prepend current year
            DATE="${YEAR}-$2"
        else
            # Use the provided date as-is
            DATE="$2"
        fi
	
        # Check if the date falls on a valid formal hall day
        DAY_OF_WEEK=$(date -j -f "%Y-%m-%d" "$DATE" +%u)
        case $DAY_OF_WEEK in
            2|3|5|7) # Tuesday, Wednesday, Friday, Sunday
                eval "python3 -m webbrowser '${FORMAL_BASE}&date=${DATE}'"
                ;;
            *)
                echo "There is no formal hall on this day. Formal halls are only on Tuesdays, Wednesdays, Fridays, and Sundays."
                ;;
        esac
    fi
elif [ "$1" = "help" ] || [ "$1" = "h" ]; then
	cat << EOF
	Script to open Jesus College Caff Menu.
	Running with arguments will result in opening Lunch Menu if before 1pm, and Dinner Menu if after 1pm.
	Running with:
		l - Lunch Menu
		d - Dinner Menu
		f - Formal Menu
		f DD - Formal Menu of Day
		f MM-DD - Formal Menu of Month and Day
EOF
else
    # Fix the date command syntax and comparison
    if [ "$(date +%H)" -gt 13 ]; then
        # dinner
        eval $DINNER
    else
        # lunch
        eval $LUNCH
    fi
fi
